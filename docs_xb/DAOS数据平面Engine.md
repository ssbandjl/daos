# DAOS 数据平面（又名 daos_engine）

## 模块接口

I/O 引擎支持允许按需加载服务器端代码的模块接口。每个模块实际上都是由 I/O 引擎通过 dlopen 动态加载的库。
模块和 I/O 引擎之间的接口在 `dss_module` 数据结构中定义。

每个模块应指定：

- 模块名称
- 来自 `daos_module_id` 的模块标识符
- 一个特征位掩码
- 一个模块初始化和完成函数

此外，模块可以选择配置：

- 一旦整个堆栈启动并运行，就会调用一个设置和清理函数
- CART RPC 处理程序
- dRPC 处理程序

## 线程模型和 Argobot 集成

I/O 引擎是一个使用 Argobots 进行非阻塞处理的多线程进程。

默认情况下，每个目标会创建一个主 xstream 和无卸载 xstream。可以通过 daos_engine 命令行参数配置实际卸载 xstream 的数量。此外，还会创建一个额外的 xstream 来处理传入的元数据请求。每个 xstream 都绑定到特定的 CPU 内核。主要的 xstream 是接收来自客户端和其他服务器的传入目标请求的流。启动特定 ULT 以在网络和 NVMe I/O 操作上取得进展。

## 线程本地存储 (TLS)

每个 xstream 分配可以通过 `dss_tls_get()` 函数访问的私有存储。注册时，每个模块可以指定一个模块键，其数据结构大小将由 TLS 中的每个 xstream 分配。 `dss_module_key_get()` 函数将为特定的已注册模块密钥返回此数据结构。

## Incast 变量集成

DAOS 使用 IV（incast 变量）在单个 IV 命名空间下的服务器之间共享值和状态，该命名空间以树的形式组织。树根称为 IV 领导者，服务器可以是叶子或非叶子。每个服务器都维护自己的 IV 缓存。在 fetch 期间，如果本地缓存不能满足请求，它会将请求转发给其父级，直到到达根（IV 领导者）。至于更新，它首先更新它的本地缓存，然后转发给它的父节点，直到它到达根节点，然后将更改传播到所有其他服务器。 IV 命名空间是每个池的，在池连接期间创建，在池断开连接时销毁。要使用IV，每个用户都需要在IV命名空间下注册自己以获得一个标识，然后它会使用这个ID在IV命名空间下获取或更新自己的IV值。

## dRPC 服务器

I/O 引擎包括一个 dRPC 服务器，用于侦听给定 Unix 域套接字上的活动。有关 dRPC 的基础知识以及 Go 和 C 中的低级 API 的更多详细信息，请参阅 [dRPC 文档](../control/drpc/README.md)。

dRPC 服务器会定期轮询传入的客户端连接和请求。它可以通过 `struct drpc_progress_context` 对象处理多个同时的客户端连接，该对象管理侦听套接字的 `struct drpc` 对象以及任何活动的客户端连接。

服务器循环在 xstream 0 中其自己的用户级线程 (ULT) 中运行。dRPC 套接字已设置为非阻塞，轮询使用超时 0，这允许服务器在 ULT 中运行，而不是在其自己的 xstream 中运行.预计该频道的流量相对较低。

### dRPC 进度

`drpc_progress` 代表 dRPC 服务器循环的一次迭代。工作流程如下：

1. 同时对侦听套接字和任何打开的客户端连接进行超时轮询。
2. 如果在客户端连接上看到任何活动：
   1.如果有数据进来：调用`drpc_recv`处理进来的数据。
   2. 如果客户端断开或连接断开：释放`struct drpc`对象并将其从`drpc_progress_context`中删除。
3. 如果在监听器上看到任何活动：
   1.如果有新连接进来：调用`drpc_accept`，将新的`struct drpc`对象添加到`drpc_progress_context`中的客户端连接列表中。
   2. 如果有错误：将`-DER_MISC`返回给调用者。这会导致在 I/O 引擎中记录错误，但不会中断 dRPC 服务器循环。在侦听器上收到错误是出乎意料的。
4. 如果没有看到任何活动，则将 `-DER_TIMEDOUT` 返回给调用者。这纯粹是出于调试目的。实际上，I/O 引擎会忽略此错误代码，因为缺少活动实际上并不是错误情况。

### dRPC 处理程序注册

单个 DAOS 模块可以通过为一个或多个 dRPC 模块 ID 注册处理函数来实现对 dRPC 消息的处理。

注册处理程序很简单。在 `dss_server_module` 字段 `sm_drpc_handlers` 中，静态分配 `struct dss_drpc_handler` 数组，数组中的最后一项清零以指示列表的结尾。将该字段设置为 NULL 表示无需注册。当 I/O 引擎加载 DAOS 模块时，它会自动注册所有的 dRPC 处理程序。

**注意：** dRPC 模式