校验和清理
介绍, https://daosio.atlassian.net/wiki/spaces/DC/pages/11223695379/Checksum+Scrubbing
校验和清理器是一项后台任务，它扫描版本对象存储 (VOS) 树，以使用存储在 DAOS 服务器上的校验和来验证数据完整性。当检测到腐败时可以采取纠正措施。
清理的数据是用户数据（使用 daos_obj_update 创建），而不是元数据，尽管元数据（VOS 树）用于扫描/迭代用户数据。
设计概述
后台任务
每个将迭代容器的池目标 ULT。如果启用了校验和和清理器，则迭代对象树。如果记录值（SV 或数组）未标记为已损坏，则进行扫描。
获取数据
计算数据的校验和
将计算出的校验和与存储的校验和进行比较。如果它们不匹配，则已检测到静默数据损坏
无声数据损坏
当检测到静默数据损坏时，将采取以下操作：
将记录标记为损坏
使用 DAOS RAS 通知系统引发事件
增加校验和错误计数器
如果达到了可配置的损坏阈值，则启动重建/排空操作
用户界面
交互模式（很高兴拥有）
用于从脚本开始清理的 dmg 命令（仅运行一次，然后退出）
校验和清理属性
这些属性可以在 DAOS 系统级别（控制平面仍然需要此功能）或单个池级别设置。如果两者都设置，池配置将覆盖系统配置。更新后，它们应该立即处于活动状态，而不是等待处理完整的清理。例如，如果模式更改为更加激进，那么它应该立即变得更加激进（基于模式配置），而不是在下一次扫描中。
池清理器模式(scrub) - 清理器如何针对每个池目标运行。容器配置可以禁用容器的清理，但不能更改模式。
惰性 - 仅在系统空闲时运行（无 IO 活动且无空间压力）
定时 - 定期运行，无论 IO 活动如何，但不要超过最大影响
池清理器频率(scrub-freq) - 清理器校验和的频率。校验和的清理频率不应高于此属性，但是，根据清理器模式，它们的清理频率可能会较低。它在内部存储为秒数，但 dmg 应该通过接受分钟、小时、天、周来更加用户友好。
池清理器最大 CPU 影响(scrub-max) - （未实现）如果存在其他 IO 活动，服务器调度程序用于运行清理器的 CPU 百分比。
清理阈值(scrub-thresh) - 池目标被逐出时的校验和错误数。值为 0 禁用自动驱逐
创建启用清理功能的池的命令可能如下所示：
dmg pool create --scm-size 1G --properties=scrub:lazy,scrub-freq:1w
# or
dmg pool create --scm-size 1G aPool
dmg pool set-prop aPool --properties=scrub:3,scrub-freq:1w
容器属性 (-> doc/user/container.md)
容器禁用清理- 如果为池启用了清理，则容器可以自行禁用它。
池查询（未实现）
在池查询中包含清理器信息。（DAOS-7680）
校验和清理器数量/估计剩余数量
上次全池扫描已完成（最大池目标完成情况）
遥测
收集并报告以下遥测指标，以便更好地了解洗涤器的运行情况。它们将在池和容器级别收集，但洗涤器 ULT Start 除外。
日程
Scrubber ULT Start - 洗涤器服务启动的日期时间
Scrubber Current Start - 当前清理作业开始的日期时间
洗涤器上次完成 - 上次洗涤作业完成的日期时间
最后持续时间 - 最后一个洗涤器完成运行所需的时间。
校验和计算计数
校验和总数 - 在洗涤器的使用寿命期间计算的校验和总数。
上次校验和计数 - 上次清理器作业期间计算的校验和数量
当前校验和计数 - 迄今为止为当前清理器作业计算的校验和数量
无声数据损坏很重要
静默数据损坏总数 - 清理对象值时发现的静默数据损坏总数。
当前静默数据损坏 - 当前清理器作业迄今为止发现的静默数据损坏数量
设计细节与实施
 
池超低温
池 ULT 的代码可在 中找到srv_pool_scrub.c。这可能有点难以理解，因为由于 ULT 和 vos_iterator 工作方式的性质，存在多层回调函数，但该文件的组织方式使得函数通常调用其上面的函数（直接或间接作为回调） ）。例如（~>是间接调用，->是直接调用）：
ds_start_scrubbing_ult ~> scrubbing_ult -> scrub_pool ~> cont_iter_scrub_cb ->
    scrub_cont ~> obj_iter_scrub_cb ...
相关页面
中间件一致性
中间件一致性
DAOS 社区
经常一起读书
蠕虫功能
蠕虫功能
DAOS 社区
页面树图标
一起组织
互操作性/{上/下}等级
互操作性/{上/下}等级
DAOS 社区
经常一起读书
成为第一个添加反应的人
2页评论
凯文·哈姆斯
2022 年 9 月 29 日
如果能够在全局 DAOS 设置中控制 Scrub Mode/Freq/Impact，那就太好了。举个例子，假设有一个存储“事件”，管理员希望在维护活动期间执行全面清理，他们会希望启动清理以使用所有 I/O 周期。
瑞安·詹森
2022 年 9 月 30 日
注意到……我们确实计划将这些属性更改为系统范围与特定于池的属性。:slight_smile: 

